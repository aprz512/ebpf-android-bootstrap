name: Build eBPF for Android

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'Makefile'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

env:
  NDK_VERSION: r27b
  CLANG_VERSION: "18"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-${CLANG_VERSION} llvm-${CLANG_VERSION} \
          libclang-${CLANG_VERSION}-dev make linux-tools-common linux-tools-generic
        # bpftool 可能在不同路径，创建符号链接确保可用
        sudo ln -sf /usr/lib/linux-tools/*/bpftool /usr/local/bin/bpftool || true

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
        unzip -q android-ndk-${NDK_VERSION}-linux.zip
        echo "ANDROID_NDK_HOME=$PWD/android-ndk-${NDK_VERSION}" >> $GITHUB_ENV

    - name: Build eBPF programs
      run: |
        export ANDROID_NDK_HOME=$PWD/android-ndk-${NDK_VERSION}
        export PATH=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        make all

    - name: List build artifacts
      run: |
        ls -la build/ || echo "No build directory"
        file build/* 2>/dev/null || echo "No files to check"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ebpf-android-binaries
        path: |
          build/*.o
          build/*_loader
        retention-days: 30
        if-no-files-found: error
